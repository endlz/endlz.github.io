<html>

<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>内网渗透测试 &lt;1&gt; 基础知识 | 3ND</title>
<link rel="shortcut icon" href="https://3nd.xyz/favicon.ico?v=1627869141145">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://3nd.xyz/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="内网渗透测试 &lt;1&gt; 基础知识 | 3ND - Atom Feed" href="https://3nd.xyz/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="内网基础知识
工作组
**工作组（Work Group）**是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能（或部门）分别列入不同的组中，以方便管理。
工作组是一个由许多在同一物理地点，而且被相同的局域网连..." />
    <meta name="keywords" content="AD" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <!--<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>-->
    <script src="/media/highlight.min.js"></script>
</head>

<body>
  <div class="main">
    <div class="main-content">
      <div class="site-header">
  <a href="https://3nd.xyz">
  <img class="avatar" src="https://3nd.xyz/images/avatar.png?v=1627869141145" alt="">
  </a>
  <h1 class="site-title">
    3ND
  </h1>
  <p class="site-description">
    夏が終わった
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    <a href="https://github.com/inspiringz" target="_blank">
      <i class="ri-github-fill"></i>
    </a>
    <a href="mailto:z@3nd.xyz" target="_blank">
      <i class="ri-mail-send-fill"></i>
  </a>
  <a href="#">
    <i class="ri-fire-fill"></i>
</a>
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              内网渗透测试 &lt;1&gt; 基础知识
            </h2>
            <div class="post-info">
              <span>
                2020-05-19
              </span>
              <span>
                10 min read
              </span>
              <span class="page-view" key="20200519154645" title="内网渗透测试 &lt;1&gt; 基础知识">
              </span>
              
                <a href="https://3nd.xyz/tag/ad/" class="post-tag">
                  # AD
                </a>
                
            </div>
            
                <div class="post-content-wrapper">
                  <div class="post-content">
                    <h2 id="内网基础知识">内网基础知识</h2>
<h3 id="工作组">工作组</h3>
<p>**工作组（Work Group）**是局域网中的一个概念。它是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能（或部门）分别列入不同的组中，以方便管理。</p>
<p>工作组是一个由许多在同一物理地点，而且被相同的局域网连接起来的用户组成的小组。相应地，一个工作组也可以是遍布一个机构的，但却被同一网络连接的用户构成的逻辑小组。在以上两种情况下，在工作组中的用户都可以以预定义的方式，共享文档、应用程序、电子函件和系统资源。</p>
<figure data-type="image" tabindex="1"><img src="https://3nd.xyz/post-images/move/2020-05-19-15-52-57.png" alt="" loading="lazy"></figure>
<p>工作组没有集中管理的作用，工作组中所有的计算机都是对等的。</p>
<h3 id="域">域</h3>
<p><strong>域（Domain）<strong>是一个具有</strong>安全边界</strong>的计算机集合（安全边界指：在两个域中，一个域中的用户无法访问另一个域中的资源），可以简单把域理解为升级版的工作组。</p>
<p>**域控（Domain Controller，DC）**是域中一台类似管理服务器的机器，负责所有连接计算机和用户的验证工作，是整个域的通信枢纽，域内所有用来验证身份的账户和密码 Hash 都保存在域控制器上。</p>
<h3 id="域环境">域环境</h3>
<h4 id="单域">单域</h4>
<p>在一个域中，一般要有至少两台域服务器，一台作为 DC，另一台作为备份 DC，活动目录的数据库（包括用户的账户信息）存储在 DC 中。</p>
<h4 id="父域和子域">父域和子域</h4>
<p>出于管理及其他需求，一般需要在网络中划分多个域，第一个域成为父域，各分部的域成为子域。划分子域便于节约信息交互花费时间、节约带宽以及细化安全策略等。</p>
<h4 id="域树">域树</h4>
<p>**域树（Tree）**是多个域通过建立信任关系组成的集合。一个域管理员只能管理本域，不能访问和管理其他域。建立信任关系（Trust Relation）可连接不同域，实现相互访问。域树中的父域和子域，不但可以按照需要实现相互管理，还可以实现跨网络分配文件、打印机等设备及资源，从而在不同域间实现网络资源的共享与管理、通信及数据传输。</p>
<figure data-type="image" tabindex="2"><img src="https://3nd.xyz/post-images/move/2020-05-19-16-14-24.png" alt="" loading="lazy"></figure>
<h4 id="域林">域林</h4>
<p>**域森林（Forest）**是指多个域树通过建立信任关系组成的集合。通过域树之间的信任关系，可以管理和使用整个域森林中的资源，并保留被兼并域树自身原有的特性。</p>
<figure data-type="image" tabindex="3"><img src="https://3nd.xyz/post-images/move/2020-05-19-16-16-56.png" alt="" loading="lazy"></figure>
<h4 id="域名服务器">域名服务器</h4>
<p>**域名服务器（Domain Name Server， DNS）**是指用来实现域名（Domain Name）和与之对应的 IP 地址（IP Address）转换的服务器。域中的计算机是使用 DNS 来定位域控制器、服务器及其他计算机、网络服务的，所以域的名字就是 DNS 域的名字。内网渗透中，大多是通过寻找 DNS 服务器来确定域控制器的位置（域控制器与 DNS 服务器通常配置在同一台机器上）。</p>
<h3 id="活动目录">活动目录</h3>
<p><strong>活动目录（Active Directory，AD）</strong> 是指域环境中提供目录服务的组件。</p>
<p>目录用于存储网络对象（例如用户、组、计算机、共享资源、打印机和联系人等）的信息，目录服务指帮用户快速、准确地从目录中找出其所需要的信息的服务。活动目录实现了目录服务，为企业提供了网络环境中集中式管理机制。</p>
<p>活动目录主要提供以下功能：账户、软件、环境集中管理，安全性增强及更可靠更短的宕机时间。</p>
<p><strong>- 域控制器域活动目录 -</strong></p>
<p>如果网路规模较大，就要把网络中的众多对象分门别类、井然有序地存放在一个大仓库中，并将检索信息整理好，以便查找、管理和使用这些对象（资源），这个拥有层次数据库就是<strong>活动目录数据库</strong>，简称 AD 库。</p>
<p><strong>如果内网中的一台机器安装了活动目录 AD，它就变成了域控制器 DC（用于存储活动目录数据库的计算机）。</strong></p>
<h3 id="安全域的划分">安全域的划分</h3>
<p>划分安全域的目的是将同一组安全等级相同的计算机划入同一个网段中，该网段中的计算机拥有相同的网络边界，并通过在网络边界上部署防火墙实现对其他域的网络访问控制策略（NACL），从而对允许哪些 IP 访问该域、允许该域访问哪些 IP 地址和网段进行设置。这些措施，将使得网络风险最小化，当攻击发生时，可以尽可能地将威胁隔离，从而降低对域内计算机的影响。</p>
<figure data-type="image" tabindex="4"><img src="https://3nd.xyz/post-images/move/2020-05-19-16-58-52.png" alt="" loading="lazy"></figure>
<p><strong>边界网络（Demilitarized Zone，DMZ）</strong> 是为了解决安装防火墙后外部网络的访问用户不能访问内部网络服务器的问题，而设立的一个非安全系统与安全系统之间的缓冲区。为一种网络架构的布置方案，常用的架设方案是在不信任的外部网络和可信任的内部网络外，创建一个面向外部网络的物理或逻辑子网，该子网能设置用于对外部网络的服务器主机。</p>
<p>一般而言，DMZ 区会有以下特点:</p>
<ol>
<li>
<p>提供服务给外界访问</p>
</li>
<li>
<p>区内 Server 不包含任何机密数据</p>
</li>
</ol>
<p>一般 DMZ 非军事区定义访问策略如下，以实现屏障功能：</p>
<ul>
<li>内网可以访问 DMZ、外网</li>
<li>外网不能访问内网、可以访问 DMZ</li>
<li>DMZ 不能访问内网、DMZ 不能访何外网</li>
</ul>
<h3 id="域内权限解读">域内权限解读</h3>
<p><strong>域本地组</strong>：用于<strong>分配权限</strong>，用通用组或全局组加入。域本地组的成员可以来自所有域的用户和组，但其作用域只能是当前域。-&gt; <strong>来自于全林，作用于本域。</strong><br>
<strong>通用组</strong>：用于<strong>组织多域的用户</strong>，将多个域的用户加入到通用组。通用组的成员可以来自所有域的用户和组，可在林中任何域中指派权限。-&gt; <strong>来自于全林，作用于全林。</strong><br>
<strong>全局组</strong>：用于<strong>组织一个域内的用户</strong>，将同一域内的用户加入全局组。全局组的成员只能来自当前域的用户和组，而作用域可以是所有的域。-&gt; <strong>来自于本域，作用于全林。</strong></p>
<p>域本地组中的权限：</p>
<pre><code>Administrators（管理员组）- 最重要的权限
Remote Desktop Users（远程登录组）
Print Operators（打印机操作员组）
Account Operators（帐号操作员组）
Server Operaters（服务器操作员组）
Backup Operators（备份操作员组）
</code></pre>
<p>全局组、通用组的一些权限：</p>
<pre><code>Domain Admins（域管理员组）— 最重要的权限，一般来说域渗透是看重这个
Enterprise Admins（企业系统管理员组）— 最重要的权限，其次是去看重这个权限
Schema Admins（架构管理员组）— 最重要的权限
Domain Users（域用户组）
</code></pre>
<h4 id="a-g-dl-p-策略">A-G-DL-P 策略</h4>
<p>A-G-DL-P 策略是指将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地分配资源权限。按照 A-G-DL-P 策略对用户进行组织和管理会更容易。</p>
<ul>
<li>A 表示用户账号（Account）</li>
<li>G 表示全局组（Global Group）</li>
<li>U 表示通用组（Universal Group）</li>
<li>DL 表示域本地租（Domain Local Group）</li>
<li>P 表示资源权限（Permission，许可）</li>
</ul>
<figure data-type="image" tabindex="5"><img src="https://3nd.xyz/post-images/move/2020-05-19-19-54-40.png" alt="" loading="lazy"></figure>
<h2 id="域环境搭建">域环境搭建</h2>
<p>Windows 10 + VMWare Workstation 15 Pro + Host Only</p>
<ul>
<li>
<p>DC: Windows Server 2012 R2: 192.168.1.1</p>
</li>
<li>
<p>Windows Server 2008 R2：192.168.1.2</p>
</li>
<li>
<p>Windows 7: 192.168.1.3</p>
</li>
</ul>
<blockquote>
<p><strong>- 网络适配器模式 -</strong><br>
<strong>1.桥接模式</strong><br>
在桥接网络中，虚拟机是一台独立的机器，虚拟机和主机好比插在同一台交换机上的两台计算机。如果主机连接开启了 DHCP 服务的（无线）路由器，虚拟机就能够自动获取 IP 地址。如果局域网内没有能提供 DHCP 服务的设备，就需要手动配置 IP 地址。<strong>只要 IP 地址在同一个网段内，局域网内所有同网段的计算机就能互相访问。</strong><br>
<strong>2.NAT 模式</strong><br>
NAT(Network Address Translator) 表示网络地址转换，虚拟机通过与物理机的连接来访问网络。<strong>虚拟机能够访问主机所在局域网内所有同网段的主机，除了主机，局域网内其他的计算机都无法访问虚拟机（因为不能再网络中共享资源）。</strong><br>
<strong>3.Host-Only 模式</strong><br>
Host-Only 虚拟网络是最私密和最严格的网络配置，虚拟机处于一个独立的网段中，与 NAT 模式比较可以发现，在 Host-only 模式下的虚拟机是无法上网的。但是，在 Host-only 模式下可以通过 Windows 提供的连接共享功能实现贡献上网，主机能和所有虚拟机互访(就像在一个局域网内一样实现文件共享等功能)。如果没有开启 Windows 的连接共享功能，那么除了主机，虚拟机与主机所在的局域网内所有其他计算机都无法互访。</p>
</blockquote>
<h3 id="windows-server-2012-r2">Windows Server 2012 R2</h3>
<ol>
<li>设置服务器 IP 地址为 192.168.1.1 ，子网掩码为 255.255.255.0，DNS 指向本机地址。</li>
</ol>
<figure data-type="image" tabindex="6"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-06-31.png" alt="" loading="lazy"></figure>
<ol start="2">
<li>更改计算机名</li>
</ol>
<figure data-type="image" tabindex="7"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-07-47.png" alt="" loading="lazy"></figure>
<ol start="3">
<li>安装域控制器和 DNS 服务</li>
</ol>
<figure data-type="image" tabindex="8"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-11-36.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="9"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-12-09.png" alt="" loading="lazy"></figure>
<ol start="4">
<li>升级为域控制器</li>
</ol>
<figure data-type="image" tabindex="10"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-18-15.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="11"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-20-27.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="12"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-26-07.png" alt="" loading="lazy"></figure>
<p>修改 Administrator 密码符合安全检查标准。</p>
<figure data-type="image" tabindex="13"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-31-00.png" alt="" loading="lazy"></figure>
<ol start="5">
<li>创建 Active Directory 用户</li>
</ol>
<p>用户名 001 ，密码 P4s5w0rd。</p>
<figure data-type="image" tabindex="14"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-41-37.png" alt="" loading="lazy"></figure>
<h3 id="windows-server-2008-r2">Windows Server 2008 R2</h3>
<figure data-type="image" tabindex="15"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-14-33.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="16"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-43-30.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="17"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-46-05.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="18"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-49-56.png" alt="" loading="lazy"></figure>
<h3 id="windows-7">Windows 7</h3>
<p>设置同 Windows Server 2008 R2，加入 hack.site 域。</p>
<figure data-type="image" tabindex="19"><img src="https://3nd.xyz/post-images/move/2020-05-19-22-47-28.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="20"><img src="https://3nd.xyz/post-images/move/2020-05-19-23-46-53.png" alt="" loading="lazy"></figure>
<h3 id="域相关命令操作">域相关命令操作</h3>
<pre><code class="language-sh">net user /domain #查看域中用户
</code></pre>
<figure data-type="image" tabindex="21"><img src="https://3nd.xyz/post-images/move/2020-05-19-23-48-19.png" alt="" loading="lazy"></figure>
<pre><code class="language-sh">net group /domain #查看域组名称
</code></pre>
<figure data-type="image" tabindex="22"><img src="https://3nd.xyz/post-images/move/2020-05-19-23-51-25.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="23"><img src="https://3nd.xyz/post-images/move/2020-05-19-23-53-10.png" alt="" loading="lazy"></figure>
<pre><code class="language-sh">net user 002 &quot;P4s5w0rd&quot; /add /domain #添加普通域用户
</code></pre>
<figure data-type="image" tabindex="24"><img src="https://3nd.xyz/post-images/move/2020-05-19-23-58-27.png" alt="" loading="lazy"></figure>
<pre><code class="language-sh">net group &quot;Domain Admins&quot; 002 /add /domain #普通域用户提升为域管理员
</code></pre>
<figure data-type="image" tabindex="25"><img src="https://3nd.xyz/post-images/move/2020-05-20-00-00-57.png" alt="" loading="lazy"></figure>
<p><strong>- 参考 -</strong></p>
<p>[1] 《内网安全攻防：渗透测试实战指南》</p>
<p>[2] <a href="https://0verwatch.top/LAN-pentest-learning-1.html">内网学习一-域基础 - 0verWatch</a></p>

                  </div>
                  <div class="toc-container">
                    <div style="position: sticky;
                    top: 20px;">
                    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">内网基础知识</a>
<ul>
<li><a href="#%E5%B7%A5%E4%BD%9C%E7%BB%84">工作组</a></li>
<li><a href="#%E5%9F%9F">域</a></li>
<li><a href="#%E5%9F%9F%E7%8E%AF%E5%A2%83">域环境</a>
<ul>
<li><a href="#%E5%8D%95%E5%9F%9F">单域</a></li>
<li><a href="#%E7%88%B6%E5%9F%9F%E5%92%8C%E5%AD%90%E5%9F%9F">父域和子域</a></li>
<li><a href="#%E5%9F%9F%E6%A0%91">域树</a></li>
<li><a href="#%E5%9F%9F%E6%9E%97">域林</a></li>
<li><a href="#%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8">域名服务器</a></li>
</ul>
</li>
<li><a href="#%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95">活动目录</a></li>
<li><a href="#%E5%AE%89%E5%85%A8%E5%9F%9F%E7%9A%84%E5%88%92%E5%88%86">安全域的划分</a></li>
<li><a href="#%E5%9F%9F%E5%86%85%E6%9D%83%E9%99%90%E8%A7%A3%E8%AF%BB">域内权限解读</a>
<ul>
<li><a href="#a-g-dl-p-%E7%AD%96%E7%95%A5">A-G-DL-P 策略</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%9F%9F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">域环境搭建</a>
<ul>
<li><a href="#windows-server-2012-r2">Windows Server 2012 R2</a></li>
<li><a href="#windows-server-2008-r2">Windows Server 2008 R2</a></li>
<li><a href="#windows-7">Windows 7</a></li>
<li><a href="#%E5%9F%9F%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C">域相关命令操作</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                  </div>
                  </div>
                </div>
          </article>
        </div>

        
          <div class="nearby-post" style="padding: 24px 32px;">
            <div class="prev-post" style="float: left;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter;text-align: left;">上一篇</div>
              <a href="https://3nd.xyz/post/2020-05-20-AD-Pentest-InfoGather/">
                <h3 class="post-title" style="text-align: left;">
                  内网渗透测试 &lt;2&gt; 信息收集
                </h3>
              </a>
            </div>
            <div class="next-posts" style="float: right;">
              <div class="aaa" style="
              margin-bottom: 24px;
              color: #343a40;
              font-weight: lighter; text-align: right;">下一篇</div>
              <a href="https://3nd.xyz/post/2020-05-11-2020-wdbctf-qlz-writeup/">
                <h3 class="post-title" style="
                text-align: right;">
                  2020 网鼎杯青龙组部分题解
                </h3>
              </a>
            </div>
          </div>
          

                

                                <div class="site-footer">
  
  <a class="rss" href="https://3nd.xyz/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

    </div>
  </div>

  <script>
    hljs.highlightAll();

    let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

    // This should probably be throttled.
    // Especially because it triggers during smooth scrolling.
    // https://lodash.com/docs/4.17.10#throttle
    // You could do like...
    // window.addEventListener("scroll", () => {
    //    _.throttle(doThatStuff, 100);
    // });
    // Only not doing it here to keep this Pen dependency-free.

    window.addEventListener("scroll", event => {
      let fromTop = window.scrollY;

      mainNavLinks.forEach((link, index) => {
        let section = document.getElementById(decodeURI(link.hash).substring(1));
        let nextSection = null
        if (mainNavLinks[index + 1]) {
          nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
        }
        if (section.offsetTop <= fromTop) {
          if (nextSection) {
            if (nextSection.offsetTop > fromTop) {
              link.classList.add("current");
            } else {
              link.classList.remove("current");
            }
          } else {
            link.classList.add("current");
          }
        } else {
          link.classList.remove("current");
        }
      });
    });
  </script>
<script src="/media/view-support.js"></script>
<script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js'], function () {
    var pageview = window.pageview(AV, {
      appId: 'HRVNDkHV80Fpk9M8c5GQqjwy-gzGzoHsz',
      appKey: 'nsyqncNCSWSOkkns1wvDlUrh',
      appClass: 'Gridea',
    });
    $('.page-view').each(function () {
      var $this = $(this);
      var key = $this.attr('key');
      var title = $this.attr('title');
      pageview.increase(key, title, function(view) {
        $("[key='" + key +"']").text(view+' views');
      });
    });
  });
</script>

</body>

</html>